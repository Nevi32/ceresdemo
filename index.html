<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Ceres | Agribusiness Intelligence Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #0f172a;
            overflow-x: hidden;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 1px 3px rgba(0,0,0,0.02), 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .network-canvas {
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
        }
        
        .node {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 10;
        }
        
        .node:hover {
            transform: translate(-50%, -50%) scale(1.15);
            z-index: 50;
        }
        
        .node-core {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 4px rgba(255,255,255,0.8);
            border: 2px solid;
            transition: all 0.3s ease;
        }
        
        .node:hover .node-core {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 0 6px rgba(59, 130, 246, 0.1);
        }
        
        .node-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
            background: rgba(255,255,255,0.95);
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .connection {
            stroke: #cbd5e1;
            stroke-width: 2;
            fill: none;
            transition: all 0.3s ease;
        }
        
        .connection.active {
            stroke: #3b82f6;
            stroke-width: 3;
            filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.4));
        }
        
        .connection.finance {
            stroke: #10b981;
            stroke-dasharray: 5,5;
        }
        
        .connection.data {
            stroke: #3b82f6;
        }
        
        .connection.sentiment {
            stroke: #f59e0b;
            stroke-dasharray: 10,5;
        }
        
        .flow-particle {
            fill: #3b82f6;
            filter: drop-shadow(0 0 4px rgba(59, 130, 246, 0.6));
        }
        
        .pulse-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(59, 130, 246, 0.3);
            animation: pulse 2s cubic-bezier(0.16, 1, 0.3, 1) infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .context-highlight {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2), 0 20px 25px -5px rgba(59, 130, 246, 0.1);
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 100;
        }
        
        .risk-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .finance-indicator {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .data-stream {
            font-size: 10px;
            position: absolute;
            background: rgba(59, 130, 246, 0.1);
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            white-space: nowrap;
            animation: floatData 3s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes floatData {
            0%, 100% { transform: translateY(0); opacity: 0.7; }
            50% { transform: translateY(-10px); opacity: 1; }
        }
        
        .input-field {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .analysis-card {
            transition: all 0.3s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #0f172a 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .cerebro-connector {
            stroke: #8b5cf6;
            stroke-width: 3;
            filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.4));
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .timeline-dot {
            position: relative;
        }
        .timeline-dot::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>
<body class="antialiased selection:bg-blue-100 selection:text-blue-900">

    <!-- Navigation -->
    <nav class="fixed top-0 w-full glass-panel z-50 px-6 py-4 border-b border-slate-200">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="h-10 w-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/30">
                    C
                </div>
                <div class="h-6 w-px bg-slate-200"></div>
                <div>
                    <span class="font-bold text-slate-900 tracking-tight text-sm uppercase">Project Ceres</span>
                    <div class="text-xs text-slate-500">Feed Model Simulation</div>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <div class="hidden md:flex items-center gap-2 text-xs text-slate-500 mono bg-slate-100 px-3 py-1.5 rounded-full">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                    NETWORK ACTIVE
                </div>
                <button onclick="resetSimulation()" class="text-sm text-slate-600 hover:text-slate-900 font-medium flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Reset
                </button>
            </div>
        </div>
    </nav>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 bg-white z-40 flex items-center justify-center transition-opacity duration-500">
        <div class="max-w-4xl mx-auto px-6 text-center">
            <div class="mb-8 relative inline-block">
                <div class="absolute inset-0 bg-blue-500/10 blur-3xl rounded-full scale-150"></div>
                <div class="w-24 h-24 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl flex items-center justify-center text-white text-4xl font-bold relative shadow-2xl shadow-blue-500/30 mx-auto">
                    C
                </div>
            </div>
            
            <h1 class="text-5xl md:text-6xl font-black tracking-tight mb-6 gradient-text">
                Project Ceres
                <span class="block text-2xl md:text-3xl font-medium text-slate-500 mt-2 tracking-normal">
                    Feed Distribution Intelligence
                </span>
            </h1>
            
            <p class="text-slate-600 text-lg max-w-2xl mx-auto mb-12 leading-relaxed">
                Experience how Ceres transforms agribusiness financing by connecting SBM Bank to the 
                complete value chain—collecting overlooked data, analyzing sentiment, and optimizing 
                financing across Aggregators, Co-ops, and Farmers.
            </p>
            
            <div class="grid md:grid-cols-3 gap-6 mb-12 max-w-3xl mx-auto">
                <div class="glass-card rounded-2xl p-6 text-center hover:shadow-xl transition-shadow">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-4 text-blue-600">
                        <i data-lucide="network" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-semibold text-slate-900 mb-2">Multi-Layer Network</h3>
                    <p class="text-sm text-slate-500">Visualize connections between Bank, Ceres Hub, Aggregators, and 100+ Farmer nodes</p>
                </div>
                
                <div class="glass-card rounded-2xl p-6 text-center hover:shadow-xl transition-shadow">
                    <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center mx-auto mb-4 text-amber-600">
                        <i data-lucide="brain" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-semibold text-slate-900 mb-2">AI Intelligence</h3>
                    <p class="text-sm text-slate-500">GPT-OSS-120B analyzes data gaps, competitor threats, and financing optimization</p>
                </div>
                
                <div class="glass-card rounded-2xl p-6 text-center hover:shadow-xl transition-shadow">
                    <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-4 text-emerald-600">
                        <i data-lucide="line-chart" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-semibold text-slate-900 mb-2">Live Analytics</h3>
                    <p class="text-sm text-slate-500">Real-time risk assessment, sentiment analysis, and portfolio optimization</p>
                </div>
            </div>
            
            <button onclick="enterPlayground()" class="group bg-slate-900 text-white px-10 py-4 rounded-full text-sm font-semibold tracking-widest uppercase flex items-center gap-3 mx-auto hover:shadow-2xl transform hover:scale-105 transition-all">
                <span>Enter Simulation</span>
                <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <!-- Main Playground Interface (Hidden initially) -->
    <div id="playground" class="hidden pt-20 min-h-screen">
        <div class="max-w-[1600px] mx-auto px-4 lg:px-6 h-[calc(100vh-80px)] flex gap-6">
            
            <!-- Left Sidebar: Context & Controls -->
            <div class="w-80 flex-shrink-0 flex flex-col gap-4 overflow-y-auto">
                <!-- Network Stats -->
                <div class="glass-panel rounded-2xl p-5">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Network Status</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-600">Active Nodes</span>
                            <span class="text-lg font-bold text-slate-900 mono" id="stat-nodes">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-600">Data Points</span>
                            <span class="text-lg font-bold text-blue-600 mono" id="stat-data">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-600">Financing (KES)</span>
                            <span class="text-lg font-bold text-emerald-600 mono" id="stat-finance">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-600">Risk Score</span>
                            <span class="text-lg font-bold text-amber-600 mono" id="stat-risk">Low</span>
                        </div>
                    </div>
                </div>

                <!-- External Influencers -->
                <div class="glass-panel rounded-2xl p-5">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">External Factors</h3>
                    <div class="space-y-2">
                        <button onclick="toggleExternalFactor('weather')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-all text-left group">
                            <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="sun" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-slate-900">Weather/Climate</div>
                                <div class="text-xs text-slate-500">Drought risk: 23%</div>
                            </div>
                        </button>
                        
                        <button onclick="toggleExternalFactor('regulation')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-all text-left group">
                            <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="scale" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-slate-900">Regulatory</div>
                                <div class="text-xs text-slate-500">Feed standards update</div>
                            </div>
                        </button>
                        
                        <button onclick="toggleExternalFactor('competitor')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-all text-left group">
                            <div class="w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-slate-900">Competitors</div>
                                <div class="text-xs text-slate-500">3 new market entrants</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-panel rounded-2xl p-5">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Actions</h3>
                    <div class="space-y-2">
                        <button onclick="addNode('farmer')" class="w-full py-2 px-4 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium text-slate-700 transition-colors flex items-center gap-2">
                            <i data-lucide="user-plus" class="w-4 h-4"></i>
                            Add Farmer Node
                        </button>
                        <button onclick="addNode('client')" class="w-full py-2 px-4 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium text-slate-700 transition-colors flex items-center gap-2">
                            <i data-lucide="building-2" class="w-4 h-4"></i>
                            Add Client Node
                        </button>
                        <button onclick="simulateBulkFinancing()" class="w-full py-2 px-4 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i data-lucide="banknote" class="w-4 h-4"></i>
                            Bulk Financing
                        </button>
                        <button onclick="exportData()" class="w-full py-2 px-4 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Export Network Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Center: Network Visualization -->
            <div class="flex-1 glass-panel rounded-2xl p-1 relative overflow-hidden flex flex-col">
                <div class="absolute top-4 left-4 z-20 flex gap-2">
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-white/90 backdrop-blur rounded-lg border border-slate-200 text-xs font-medium text-slate-600 shadow-sm">
                        <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                        Data Flow
                    </div>
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-white/90 backdrop-blur rounded-lg border border-slate-200 text-xs font-medium text-slate-600 shadow-sm">
                        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                        Financing
                    </div>
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-white/90 backdrop-blur rounded-lg border border-slate-200 text-xs font-medium text-slate-600 shadow-sm">
                        <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                        Sentiment
                    </div>
                </div>

                <div class="network-canvas w-full h-full relative rounded-xl bg-white overflow-hidden" id="network-container">
                    <svg id="network-svg" class="absolute inset-0 w-full h-full pointer-events-none">
                        <defs>
                            <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="20" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#3b82f6" />
                            </marker>
                            <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="20" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#10b981" />
                            </marker>
                            <marker id="arrow-purple" markerWidth="10" markerHeight="10" refX="20" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#8b5cf6" />
                            </marker>
                        </defs>
                        <g id="connections-layer"></g>
                        <g id="particles-layer"></g>
                    </svg>

                    <!-- Ceres Central Hub (Always in center) -->
                    <div class="node" style="left: 50%; top: 50%;" id="node-ceres">
                        <div class="pulse-ring" style="width: 120px; height: 120px;"></div>
                        <div class="pulse-ring" style="width: 140px; height: 140px; animation-delay: 0.5s;"></div>
                        <div class="node-core w-20 h-20 bg-gradient-to-br from-indigo-600 to-blue-700 text-white border-indigo-400 shadow-xl shadow-indigo-500/30">
                            <i data-lucide="brain-circuit" class="w-10 h-10"></i>
                        </div>
                        <div class="node-label bg-indigo-100 text-indigo-700 border-indigo-200 font-bold">CERES INTELLIGENCE</div>
                    </div>
                    
                    <!-- Dynamic nodes will be inserted here -->
                </div>
            </div>

            <!-- Right Sidebar: AI Chat & Details -->
            <div class="w-96 flex-shrink-0 flex flex-col gap-4">
                <!-- Node Details Panel (Context Window) -->
                <div id="node-details" class="glass-panel rounded-2xl p-5 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-slate-900" id="detail-title">Node Details</h3>
                        <button onclick="closeNodeDetails()" class="p-1 hover:bg-slate-100 rounded">
                            <i data-lucide="x" class="w-4 h-4 text-slate-400"></i>
                        </button>
                    </div>
                    <div id="detail-content" class="space-y-4 max-h-64 overflow-y-auto">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- AI Assistant -->
                <div class="glass-panel rounded-2xl flex-1 flex flex-col overflow-hidden min-h-[400px]">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                                <i data-lucide="bot" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-900 text-sm">Ceres Analyst</h3>
                                <p class="text-xs text-slate-500">GPT-OSS-120B • Network Mode</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm">
                        <div class="chat-message flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 text-blue-600">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3 border border-slate-100">
                                <p class="text-slate-700">Network visualization active. I can see <strong>Ceres Hub</strong> is positioned to capture overlooked data points like farmer sentiment on feed quality. What would you like to simulate?</p>
                                
                                <div class="mt-3 flex flex-wrap gap-2">
                                    <button onclick="aiSuggestScenario()" class="text-xs px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors">
                                        Suggest Risk Scenario
                                    </button>
                                    <button onclick="aiAddCompetitor()" class="text-xs px-3 py-1.5 bg-amber-100 text-amber-700 rounded-full hover:bg-amber-200 transition-colors">
                                        Add Competitor Node
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-slate-100 bg-white">
                        <div class="flex gap-2">
                            <input type="text" id="ai-input" placeholder="Ask about network risks, add timeline..." 
                                   class="flex-1 input-field px-4 py-2.5 rounded-xl text-sm"
                                   onkeypress="if(event.key==='Enter') sendToAI()">
                            <button onclick="sendToAI()" class="p-2.5 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition-colors">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="aiAddTimeline()" class="text-xs px-3 py-1.5 border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50">
                                + Timeline
                            </button>
                            <button onclick="aiAnalyzeSentiment()" class="text-xs px-3 py-1.5 border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50">
                                Analyze Sentiment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel: Analytics & Charts -->
        <div class="max-w-[1600px] mx-auto px-4 lg:px-6 mt-6 pb-8">
            <div class="glass-panel rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-900">Portfolio Analytics</h3>
                    <div class="flex gap-2">
                        <select class="text-sm border border-slate-200 rounded-lg px-3 py-1.5 bg-white">
                            <option>Last 30 Days</option>
                            <option>Last Quarter</option>
                            <option>YTD</option>
                        </select>
                        <button onclick="refreshAnalytics()" class="p-1.5 hover:bg-slate-100 rounded-lg">
                            <i data-lucide="refresh-cw" class="w-4 h-4 text-slate-600"></i>
                        </button>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl p-4 border border-slate-100">
                        <h4 class="text-sm font-semibold text-slate-700 mb-4">Financing Distribution</h4>
                        <canvas id="financeChart" height="200"></canvas>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100">
                        <h4 class="text-sm font-semibold text-slate-700 mb-4">Data Collection Sources</h4>
                        <canvas id="dataChart" height="200"></canvas>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100">
                        <h4 class="text-sm font-semibold text-slate-700 mb-4">Risk vs. Return Matrix</h4>
                        <canvas id="riskChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Node Edit Modal -->
    <div id="node-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeNodeModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg">
            <div class="glass-panel rounded-2xl p-6 shadow-2xl bg-white/95 m-4">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-slate-900" id="modal-title">Edit Node</h3>
                    <button onclick="closeNodeModal()" class="p-2 hover:bg-slate-100 rounded-lg">
                        <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
                    </button>
                </div>
                
                <div id="modal-body" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Dynamic form fields -->
                </div>
                
                <div class="mt-6 pt-6 border-t border-slate-100 flex gap-3">
                    <button onclick="closeNodeModal()" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">
                        Cancel
                    </button>
                    <button onclick="saveNodeData()" class="flex-1 px-4 py-2.5 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/10">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State Management with LocalStorage
        let networkState = {
            nodes: [
                { id: 'sbm', type: 'bank', label: 'SBM Bank', x: 50, y: 20, data: { allocation: 50000000, deployed: 12000000 }, connections: ['ceres'] },
                { id: 'ceres', type: 'hub', label: 'Ceres Intelligence', x: 50, y: 50, data: { insights: 342, sentiment: 4.2 }, connections: [] },
                { id: 'akfema', type: 'aggregator', label: 'AKFEMA Feeds', x: 30, y: 35, data: { volume: 450, clients: 85, satisfaction: 4.1 }, connections: ['ceres'] },
                { id: 'coop1', type: 'client', label: 'Rift Valley Co-op', x: 20, y: 60, data: { members: 250, herdSize: 1800, outstanding: 3500000 }, connections: ['ceres'] },
                { id: 'farmer1', type: 'farmer', label: 'Small Holder A', x: 15, y: 80, data: { herd: 12, satisfaction: 3.8, creditScore: 72 }, connections: ['ceres'] }
            ],
            transactions: [],
            externalFactors: [],
            analytics: {
                totalDisbursed: 12000000,
                dataPoints: 342,
                avgRisk: 2.4
            }
        };

        // Load from localStorage
        function loadState() {
            const saved = localStorage.getItem('ceresNetworkState');
            if (saved) {
                networkState = JSON.parse(saved);
                renderNetwork();
                updateStats();
            }
        }

        function saveState() {
            localStorage.setItem('ceresNetworkState', JSON.stringify(networkState));
        }

        let currentEditNode = null;
        let charts = {};

        // Welcome Screen Transition
        function enterPlayground() {
            document.getElementById('welcome-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('playground').classList.remove('hidden');
                initCharts();
                renderNetwork();
                simulateInitialData();
            }, 500);
        }

        // Network Rendering
        function renderNetwork() {
            const container = document.getElementById('network-container');
            // Clear existing dynamic nodes except Ceres
            const existing = container.querySelectorAll('.dynamic-node');
            existing.forEach(e => e.remove());
            
            const svg = document.getElementById('connections-layer');
            svg.innerHTML = '';
            
            // Render connections first
            networkState.nodes.forEach(node => {
                if (node.connections) {
                    node.connections.forEach(targetId => {
                        drawConnection(node, targetId);
                    });
                }
            });
            
            // Render nodes
            networkState.nodes.forEach(node => {
                if (node.id === 'ceres') return; // Skip center hub (static HTML)
                createNodeElement(node);
            });
            
            updateStats();
            lucide.createIcons();
        }

        function createNodeElement(node) {
            const container = document.getElementById('network-container');
            const div = document.createElement('div');
            div.className = 'node dynamic-node';
            div.id = `node-${node.id}`;
            div.style.left = node.x + '%';
            div.style.top = node.y + '%';
            div.onclick = () => openNodeDetails(node);
            
            const colors = {
                bank: 'text-amber-600 border-amber-200 bg-amber-50',
                aggregator: 'text-blue-600 border-blue-200 bg-blue-50',
                client: 'text-purple-600 border-purple-200 bg-purple-50',
                farmer: 'text-emerald-600 border-emerald-200 bg-emerald-50',
                competitor: 'text-red-600 border-red-200 bg-red-50',
                external: 'text-slate-600 border-slate-200 bg-slate-50'
            };
            
            const icons = {
                bank: 'landmark',
                aggregator: 'warehouse',
                client: 'building-2',
                farmer: 'user',
                competitor: 'trending-up',
                external: 'alert-circle'
            };
            
            div.innerHTML = `
                <div class="node-core ${colors[node.type]}">
                    <i data-lucide="${icons[node.type]}" class="w-6 h-6"></i>
                </div>
                ${node.data.sentiment ? `<div class="risk-badge ${node.data.sentiment < 3 ? 'bg-red-500' : 'bg-green-500'}">${node.data.sentiment}</div>` : ''}
                ${node.data.outstanding ? `<div class="finance-indicator">K${(node.data.outstanding/1000000).toFixed(1)}M</div>` : ''}
                <div class="node-label bg-white/90 backdrop-blur border-slate-200 text-slate-700">${node.label}</div>
            `;
            
            container.appendChild(div);
        }

        function drawConnection(fromNode, toId) {
            const toNode = networkState.nodes.find(n => n.id === toId);
            if (!toNode) return;
            
            const svg = document.getElementById('connections-layer');
            const container = document.getElementById('network-container');
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            
            const x1 = (fromNode.x / 100) * width;
            const y1 = (fromNode.y / 100) * height;
            const x2 = (toNode.x / 100) * width;
            const y2 = (toNode.y / 100) * height;
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            
            // Curved line
            const dx = x2 - x1;
            const dy = y2 - y1;
            const dr = Math.sqrt(dx * dx + dy * dy) * 2;
            
            path.setAttribute('d', `M${x1},${y1} A${dr},${dr} 0 0,1 ${x2},${y2}`);
            path.setAttribute('class', 'connection data');
            path.setAttribute('marker-end', 'url(#arrow-blue)');
            
            svg.appendChild(path);
        }

        // Node Interaction
        function openNodeDetails(node) {
            currentEditNode = node;
            const panel = document.getElementById('node-details');
            const title = document.getElementById('detail-title');
            const content = document.getElementById('detail-content');
            
            panel.classList.remove('hidden');
            title.textContent = node.label;
            
            // Generate context-specific content
            let html = '';
            
            if (node.type === 'farmer') {
                html = `
                    <div class="space-y-3">
                        <div class="flex justify-between p-3 bg-slate-50 rounded-lg">
                            <span class="text-sm text-slate-600">Herd Size</span>
                            <span class="font-semibold">${node.data.herd} cattle</span>
                        </div>
                        <div class="flex justify-between p-3 bg-slate-50 rounded-lg">
                            <span class="text-sm text-slate-600">Feed Satisfaction</span>
                            <div class="flex items-center gap-1">
                                ${generateStars(node.data.sentiment)}
                                <span class="text-sm font-semibold ml-2">${node.data.sentiment}/5</span>
                            </div>
                        </div>
                        <div class="flex justify-between p-3 bg-slate-50 rounded-lg">
                            <span class="text-sm text-slate-600">Credit Score</span>
                            <span class="font-semibold ${node.data.creditScore > 70 ? 'text-emerald-600' : 'text-amber-600'}">${node.data.creditScore}/100</span>
                        </div>
                        <div class="mt-4">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Overlooked Data (Ceres Collection)</label>
                            <div class="space-y-2">
                                <div class="flex items-center gap-2 text-sm">
                                    <i data-lucide="check-circle" class="w-4 h-4 text-blue-500"></i>
                                    <span>Feed quality feedback: "Protein content lower than competitors"</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <i data-lucide="check-circle" class="w-4 h-4 text-blue-500"></i>
                                    <span>Delivery timing: Prefers Tuesday AM drops</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <i data-lucide="check-circle" class="w-4 h-4 text-blue-500"></i>
                                    <span>Pain point: Price volatility during dry season</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="editCurrentNode()" class="w-full mt-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-medium hover:bg-slate-800">
                            Edit Profile / Upload Docs
                        </button>
                    </div>
                `;
            } else if (node.type === 'aggregator') {
                html = `
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <div class="text-2xl font-bold text-blue-600">${node.data.volume}t</div>
                            <div class="text-xs text-blue-600/70">Monthly Volume</div>
                        </div>
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                            <div class="text-2xl font-bold text-emerald-600">${node.data.clients}</div>
                            <div class="text-xs text-emerald-600/70">Active Clients</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">Client Retention</span>
                            <span class="font-medium">94%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 94%"></div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Competitor Intelligence</label>
                        <div class="space-y-2 text-sm text-slate-600">
                            <p>• Competitor X offering 12% lower prices in Q2</p>
                            <p>• Gap in organic feed segment identified</p>
                            <p>• Opportunity: Bundle financing with feed sales</p>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div class="space-y-3">
                        <div class="flex justify-between p-3 bg-slate-50 rounded-lg">
                            <span class="text-sm text-slate-600">Type</span>
                            <span class="font-semibold capitalize">${node.type}</span>
                        </div>
                        <div class="flex justify-between p-3 bg-slate-50 rounded-lg">
                            <span class="text-sm text-slate-600">Node ID</span>
                            <span class="font-mono text-xs">${node.id}</span>
                        </div>
                        <button onclick="editCurrentNode()" class="w-full mt-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-medium hover:bg-slate-800">
                            Edit Node Data
                        </button>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            lucide.createIcons();
            
            // Highlight node visually
            document.querySelectorAll('.node').forEach(n => n.classList.remove('context-highlight'));
            document.getElementById(`node-${node.id}`).classList.add('context-highlight');
        }

        function closeNodeDetails() {
            document.getElementById('node-details').classList.add('hidden');
            document.querySelectorAll('.node').forEach(n => n.classList.remove('context-highlight'));
        }

        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i data-lucide="star" class="w-3 h-3 fill-amber-400 text-amber-400"></i>';
                } else {
                    stars += '<i data-lucide="star" class="w-3 h-3 text-slate-300"></i>';
                }
            }
            return stars;
        }

        function editCurrentNode() {
            closeNodeDetails();
            openNodeModal(currentEditNode);
        }

        // Modal Forms
        function openNodeModal(node) {
            currentEditNode = node;
            document.getElementById('node-modal').classList.remove('hidden');
            document.getElementById('modal-title').textContent = `Edit ${node.label}`;
            
            const body = document.getElementById('modal-body');
            
            if (node.type === 'farmer') {
                body.innerHTML = `
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Farmer Name</label>
                        <input type="text" id="edit-name" value="${node.label}" class="w-full input-field px-4 py-2 rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Herd Size</label>
                            <input type="number" id="edit-herd" value="${node.data.herd}" class="w-full input-field px-4 py-2 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Credit Score</label>
                            <input type="number" id="edit-credit" value="${node.data.creditScore}" class="w-full input-field px-4 py-2 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Feed Satisfaction (1-5)</label>
                        <input type="range" id="edit-sentiment" min="1" max="5" step="0.1" value="${node.data.sentiment}" class="w-full accent-blue-600" oninput="document.getElementById('sentiment-val').textContent = this.value">
                        <div class="text-right text-sm text-slate-600 mt-1" id="sentiment-val">${node.data.sentiment}</div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Feedback/Notes</label>
                        <textarea id="edit-notes" rows="3" class="w-full input-field px-4 py-2 rounded-lg" placeholder="Specific insights about feed preferences, delivery issues, etc."></textarea>
                    </div>
                    <div class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:border-blue-300 hover:bg-blue-50/50 transition-colors cursor-pointer">
                        <i data-lucide="upload" class="w-8 h-8 mx-auto mb-2 text-slate-400"></i>
                        <p class="text-sm text-slate-600">Drop bank statements or farm records here</p>
                        <p class="text-xs text-slate-400 mt-1">PDF, CSV, or Images</p>
                    </div>
                `;
            } else {
                body.innerHTML = `
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Label</label>
                        <input type="text" id="edit-name" value="${node.label}" class="w-full input-field px-4 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Financing Outstanding (KES)</label>
                        <input type="number" id="edit-outstanding" value="${node.data.outstanding || 0}" class="w-full input-field px-4 py-2 rounded-lg">
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function closeNodeModal() {
            document.getElementById('node-modal').classList.add('hidden');
        }

        function saveNodeData() {
            if (!currentEditNode) return;
            
            const name = document.getElementById('edit-name')?.value;
            if (name) currentEditNode.label = name;
            
            if (currentEditNode.type === 'farmer') {
                currentEditNode.data.herd = parseInt(document.getElementById('edit-herd').value) || 0;
                currentEditNode.data.creditScore = parseInt(document.getElementById('edit-credit').value) || 0;
                currentEditNode.data.sentiment = parseFloat(document.getElementById('edit-sentiment').value) || 3;
            } else {
                currentEditNode.data.outstanding = parseInt(document.getElementById('edit-outstanding')?.value) || 0;
            }
            
            saveState();
            renderNetwork();
            closeNodeModal();
            
            // Show success in chat
            addChatMessage('system', `Updated ${currentEditNode.label}. Data synchronized with Ceres intelligence layer.`, 'success');
        }

        // AI Integration
        async function sendToAI() {
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            if (!text) return;
            
            addChatMessage('user', text);
            input.value = '';
            
            // Show typing
            showAITyping();
            
            try {
                const response = await fetch('https://api.cerebras.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer csk-8rc5w8jy3hdeyj89t8tepx59554h8nym86ep6pdctddx9n65'
                    },
                    body: JSON.stringify({
                        model: 'gpt-oss-120b',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are Ceres AI, analyzing an agribusiness feed distribution network for SBM Bank. The network has a central Ceres Intelligence hub connecting Bank, Aggregators (like AKFEMA), Commercial Clients (Co-ops, Wholesalers), and Farmers. Provide structured, concise insights about risk assessment, financing optimization, and overlooked data collection. Format with bullet points and bold key metrics. Suggest specific actions like "Add competitor node" or "Highlight risk".'
                            },
                            {
                                role: 'user',
                                content: text + '\n\nCurrent network state: ' + JSON.stringify(networkState.analytics)
                            }
                        ],
                        max_completion_tokens: 400,
                        temperature: 0.7
                    })
                });
                
                removeAITyping();
                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    formatAIResponse(data.choices[0].message.content);
                }
            } catch (error) {
                removeAITyping();
                // Fallback simulation
                setTimeout(() => {
                    simulateAIResponse(text);
                }, 1000);
            }
        }

        function formatAIResponse(text) {
            // Format the AI response with better styling
            const formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-900">$1</strong>')
                .replace(/• (.*)/g, '<div class="flex gap-2 mb-1"><span class="text-blue-500">•</span><span>$1</span></div>')
                .replace(/\n\n/g, '</p><p class="mb-2">');
            
            addChatMessage('ai', formatted, 'formatted');
        }

        function simulateAIResponse(input) {
            const responses = [
                {
                    text: "**Risk Alert:** Rift Valley Co-op showing stress signals\n\n• 3 farmers reported delayed payments\n• Competitor offering 15% lower feed prices\n• **Recommendation:** Inject KES 2M emergency credit line\n• **Action:** Highlight co-op node in red",
                    actions: [
                        { label: 'Add Emergency Credit', onclick: 'injectCredit("coop1", 2000000)' },
                        { label: 'View Risk Report', onclick: 'showRiskReport()' }
                    ]
                },
                {
                    text: "**Market Opportunity Detected**\n\n• Small farmers (nodes 4-8) complaining about delivery timing\n• Ceres data shows 62% prefer Tuesday AM drops\n• Current aggregator only delivers Fridays\n• **Gap:** Weekend availability completely untapped",
                    actions: [
                        { label: 'Add Logistics Node', onclick: 'aiAddNode("logistics")' },
                        { label: 'Survey Farmers', onclick: 'bulkSurvey()' }
                    ]
                }
            ];
            
            const response = responses[Math.floor(Math.random() * responses.length)];
            addChatMessage('ai', response.text, 'rich', response.actions);
        }

        function addChatMessage(role, content, type = 'simple', actions = []) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-message flex gap-3 ' + (role === 'user' ? 'flex-row-reverse' : '');
            
            if (role === 'user') {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0 text-slate-600">
                        <i data-lucide="user" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 bg-slate-100 rounded-2xl rounded-tr-none p-3 text-slate-700">
                        ${content}
                    </div>
                `;
            } else if (role === 'system') {
                const bgColor = type === 'success' ? 'bg-emerald-50 border-emerald-100 text-emerald-800' : 'bg-slate-50 border-slate-100';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0 text-slate-600">
                        <i data-lucide="info" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 ${bgColor} rounded-2xl rounded-tl-none p-3 border text-sm">
                        ${content}
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 text-blue-600">
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 bg-white rounded-2xl rounded-tl-none p-4 border border-slate-100 shadow-sm">
                        <div class="text-sm text-slate-700 leading-relaxed mb-3">
                            ${content}
                        </div>
                        ${actions.length ? `
                            <div class="flex flex-wrap gap-2 pt-2 border-t border-slate-50">
                                ${actions.map(a => `
                                    <button onclick="${a.onclick}" class="text-xs px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full transition-colors font-medium">
                                        ${a.label}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function showAITyping() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.id = 'ai-typing';
            div.className = 'chat-message flex gap-3';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 text-blue-600">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </div>
                <div class="flex-1 bg-white rounded-2xl rounded-tl-none p-4 border border-slate-100 shadow-sm flex items-center gap-1">
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeAITyping() {
            const typing = document.getElementById('ai-typing');
            if (typing) typing.remove();
        }

        // AI Actions
        function aiSuggestScenario() {
            addChatMessage('user', 'Simulate a risk scenario for the network');
            simulateAIResponse('risk scenario');
        }

        function aiAddCompetitor() {
            const id = 'competitor-' + Date.now();
            networkState.nodes.push({
                id: id,
                type: 'competitor',
                label: 'New Competitor',
                x: 80,
                y: 30,
                data: { marketShare: 12, threatLevel: 'medium' },
                connections: ['ceres']
            });
            saveState();
            renderNetwork();
            addChatMessage('system', 'Added competitor node to network. Monitoring market share impact.', 'success');
        }

        function aiAddTimeline() {
            addChatMessage('ai', "**Q3 2024 Timeline Projection**\n\n• **Month 1:** Aggregator financing peaks (harvest season)\n• **Month 2:** Risk wave expected - drought conditions\n• **Month 3:** Ceres recommendation algorithm activation");
        }

        function aiAnalyzeSentiment() {
            addChatMessage('ai', "**Farmer Sentiment Analysis** (Ceres Collected Data)\n\n**Positive Signals (68%):**\n• Feed quality consistency appreciated\n• Mobile payment integration working well\n\n**Friction Points (32%):**\n• Delivery timing inflexibility\n• Price communication lacks transparency\n\n**SBM Portfolio Impact:** Medium risk if competitor addresses timing issue.");
        }

        // Actions
        function addNode(type) {
            const id = type + '-' + Date.now();
            const yPos = type === 'farmer' ? 75 + Math.random() * 15 : 55 + Math.random() * 20;
            const xPos = 20 + Math.random() * 60;
            
            const newNode = {
                id: id,
                type: type,
                label: type === 'farmer' ? 'New Farmer' : 'New Client',
                x: xPos,
                y: yPos,
                data: type === 'farmer' ? { herd: 0, satisfaction: 3.5, creditScore: 60 } : { outstanding: 0 },
                connections: ['ceres']
            };
            
            networkState.nodes.push(newNode);
            saveState();
            renderNetwork();
            addChatMessage('system', `Added new ${type} node to network. Ceres is profiling...`, 'success');
        }

        function toggleExternalFactor(type) {
            addChatMessage('ai', `**${type.toUpperCase()} Factor Analysis**\n\nSimulating impact on current portfolio...\n\n• **Immediate:** 3 nodes show increased risk\n• **30-day:** Financing costs may rise 2.3%\n• **Mitigation:** Ceres suggests hedging strategy`);
        }

        function simulateBulkFinancing() {
            const amount = 5000000;
            networkState.analytics.totalDisbursed += amount;
            saveState();
            updateStats();
            addChatMessage('system', `Bulk financing of KES ${amount.toLocaleString()} distributed across 12 active farmer nodes.`, 'success');
            
            // Visual effect
            document.querySelectorAll('.node-core').forEach(node => {
                node.style.transform = 'scale(1.2)';
                setTimeout(() => node.style.transform = '', 300);
            });
        }

        function injectCredit(nodeId, amount) {
            const node = networkState.nodes.find(n => n.id === nodeId);
            if (node) {
                node.data.outstanding = (node.data.outstanding || 0) + amount;
                networkState.analytics.totalDisbursed += amount;
                saveState();
                renderNetwork();
                addChatMessage('system', `Emergency credit of KES ${amount.toLocaleString()} disbursed to ${node.label}`, 'success');
            }
        }

        function updateStats() {
            document.getElementById('stat-nodes').textContent = networkState.nodes.length;
            document.getElementById('stat-data').textContent = networkState.analytics.dataPoints;
            document.getElementById('stat-finance').textContent = (networkState.analytics.totalDisbursed / 1000000).toFixed(1) + 'M';
            document.getElementById('stat-risk').textContent = networkState.analytics.avgRisk < 3 ? 'Low' : 'Medium';
        }

        // Charts
        function initCharts() {
            const ctx1 = document.getElementById('financeChart').getContext('2d');
            charts.finance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Aggregators', 'Co-ops', 'Large Farmers', 'Small Farmers'],
                    datasets: [{
                        data: [40, 30, 20, 10],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } }
                }
            });

            const ctx2 = document.getElementById('dataChart').getContext('2d');
            charts.data = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Financial', 'Sentiment', 'Logistics', 'Competitor', 'Weather'],
                    datasets: [{
                        label: 'Data Points',
                        data: [120, 85, 64, 40, 33],
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });

            const ctx3 = document.getElementById('riskChart').getContext('2d');
            charts.risk = new Chart(ctx3, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Portfolio Nodes',
                        data: [
                            { x: 2, y: 15 },
                            { x: 3, y: 22 },
                            { x: 4, y: 18 },
                            { x: 2.5, y: 25 },
                            { x: 3.5, y: 12 }
                        ],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Risk Score' }, min: 0, max: 5 },
                        y: { title: { display: true, text: 'Return %' }, min: 0, max: 30 }
                    }
                }
            });
        }

        function refreshAnalytics() {
            // Simulate data update
            charts.data.data.datasets[0].data = charts.data.data.datasets[0].data.map(v => v + Math.floor(Math.random() * 10));
            charts.data.update();
            addChatMessage('system', 'Analytics dashboards refreshed with latest Ceres intelligence.', 'success');
        }

        function exportData() {
            const dataStr = JSON.stringify(networkState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ceres-network-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            addChatMessage('system', 'Network data exported to JSON. All node profiles, sentiment data, and financing records included.', 'success');
        }

        function simulateInitialData() {
            setTimeout(() => {
                addChatMessage('system', 'Network topology loaded with 5 active nodes and 3 data streams.', 'info');
                addChatMessage('ai', '**Welcome to the Feed Model Simulation**\n\nI can help you:\n• **Analyze** overlooked farmer sentiment data\n• **Simulate** competitor entry scenarios\n• **Optimize** financing distribution across hubs\n\nTry selecting a farmer node to see Ceres-specific data collection points banks typically miss.', 'simple');
            }, 1000);
        }

        function resetSimulation() {
            if (confirm('Clear all network data? This will reset to default state.')) {
                localStorage.removeItem('ceresNetworkState');
                location.reload();
            }
        }

        // Init
        window.addEventListener('load', loadState);
    </script>
</body>
</html>
